<?xml version="1.0" encoding="UTF-8"?>
<!--
  WANT - A build management tool.                                 
  Copyright (c) 2001-2003 Juancarlo Anez, Caracas, Venezuela.          
  All rights reserved.
  

  This library is free software; you can redistribute it and/or
  modify it under the terms of the GNU Lesser General Public
  License as published by the Free Software Foundation; either
  version 2.1 of the License, or (at your option) any later version.
  
  This library is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  Lesser General Public License for more details.
  
  You should have received a copy of the GNU Lesser General Public
  License along with this library; if not, write to the Free Software
  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

{ $Id: want.xml,v 1.83 2004/05/29 17:23:09 juanco Exp $ }

This is the Want script for building Want.
See http://www.suigeneris.org/want/ for details.
-->
<project name="MitsuDrv1C" basedir="../.." default="build">
    <property name="basepath" value="" />
    <regexp property="basepath" text="${basedir}" pattern="^\/" subst="" />
    <property name="src" value="${basepath}/source" />
    <property name="test" value="${basepath}/tests/DUnit" />
    <property name="shared" value="${src}/shared" />
    <property name="MitsuDrv1C" value="${src}/MitsuDrv1C" />
    <property name="MitsuDrvTest" value="${src}/MitsuDrvTest" />
    <property name="MitsuDrv1CNative" value="${src}/MitsuDrv1CNative" />
    <property name="MitsuDrv1CTst" value="${src}/MitsuDrv1CTst" />
    <property name="setup" value="${basepath}/setup/MitsuDrv1C" />
    <property name="bin" value="${setup}/bin" />
    <property name="dcu" value="${setup}/dcu" />
    <property name="res" value="${setup}/res" />
    <property name="brcc" value="${setup}/res/util/brcc32.exe" />
    <property name="old.version" value="?{${setup}/release.ini:releases:current}" />
    <regexp property="old.build" text="${old.version}" pattern="^.*\.([0-9]+)$" subst="\1" />
    <regexp property="build_1c" text="${old.version}" pattern="^([0-9]*)\.([0-9]*)\.([0-9]*)\.([0-9]*)" subst="\1_\2_\3_\4" />
    <property name="component_1c_32_win32_dll" value="mitsudrv_32_${build_1c}_win_32.dll" />
    <property name="component_1c_32_win64_dll" value="mitsudrv_32_${build_1c}_win_x64.dll" />
    <property name="component_1c_40_win32_dll" value="mitsudrv_40_${build_1c}_win_32.dll" />
    <property name="component_1c_40_win64_dll" value="mitsudrv_40_${build_1c}_win_x64.dll" />
    <property name="build" value="={${old.build}}" />
    <property name="CompanyName" value="?{${setup}/release.ini:Company:CompanyName}" />
    <property name="CompanySite" value="?{${setup}/release.ini:Company:CompanySite}" />
    <property name="DeviceName" value="?{${setup}/release.ini:Company:DeviceName}" />
    <property name="ProductName" value="?{${setup}/release.ini:Company:ProductName}" />
    <property name="DriverFileDescription" value="?{${setup}/release.ini:Company:DriverFileDescription}" />
    <property name="DriverFilename" value="?{${setup}/release.ini:Company:DriverFilename}" />
    <property name="TestFileDescription" value="?{${setup}/release.ini:Company:TestFileDescription}" />
    <property name="TestFilename" value="?{${setup}/release.ini:Company:TestFilename}" />
    <property name="Native1ClibFileName" value="?{${setup}/release.ini:Company:Native1ClibFileName}" />
    <property name="Native1ClibDescription" value="?{${setup}/release.ini:Company:Native1ClibDescription}" />
    <regexp property="version" text="${old.version}" pattern="\.[0-9]*$" subst=".${build}" />
    <regexp property="comma.version" pattern="\." subst="," text="${version}" />
    <regexp property="version2" pattern="^[0-9]*\.[0-9]*" text="${version}" />
    <tstamp>
        <format property="when" pattern="yyyy,mm,dd,HH,nn,ss" />
        <format property="date.tag" pattern="yyyy-mm-dd" />
    </tstamp>
    <target name="prepare">
        <mkdir dir="${dcu}" />
        <mkdir dir="${bin}" />
        <echo message="version=${version}" />
        <echo message="build=${build}" />
        <echo message="build_1c=${build_1c}" />
        <delete dir="${src}">
            <include name="**/*.dcu" />
            <include name="**/*.exe" />
            <include name="**/*.dll" />
            <include name="**/*.rsm" />
            <include name="**/*.log" />
            <include name="**/*.~*" />
            <include name="**/*.bak" />
        </delete>
    </target>
    <target name="clean">
        <delete dir="${dcu}">
            <include name="**/*.dcu" />
        </delete>
        <delete dir="${bin}">
            <include name="**/*.exe" />
            <include name="**/*.dll" />
            <include name="**/*.rsm" />
        </delete>
    </target>
    <target name="internal-MitsuDrv-test" depends="prepare">
        <delete dir="${dcu}">
            <include name="*.dcu" />
        </delete>
        <property name="MitsuDrvTest.app" value="MitsuDrvTestLib" />
        <dcc basedir="${test}/MitsuDrvTest" source="${MitsuDrvTest.app}.dpr">
            <exeoutput path="${test}/MitsuDrvTest/Bin" />
            <dcuoutput path="${dcu}" />
            <build value="true" />
            <debug value="false" />
            <console value="true" />
            <writeableconst value="true" />
            <warnings value="true" />
            <warning name="SYMBOL_PLATFORM" value="off" />
            <warning name="SYMBOL_DEPRECATED" value="off" />
            <warning name="UNIT_PLATFORM" value="off" />
            <warning name="UNSAFE_CODE" value="off" />
            <warning name="UNSAFE_TYPE" value="off" />
            <warning name="UNSAFE_CAST" value="off" />
            <hints value="true" />
            <define name="DUNIT_DLL" />
            <define name="SUPPORTS_WIDESTRING" />
        </dcc>
        <dunit testlib="${test}/MitsuDrvTest/bin/${MitsuDrvTest.app}" />
    </target>
    <target name="makesetup64">
        <property name="Architecture" value="ArchitecturesInstallIn64BitMode=x64" />
        <property name="Arch" value="Win64" />
        <property name="Archbit" value="64bit" />
        <property name="Arch2" value="(64-bit)" />
        <echo input="${setup}/res/setup_template.iss" file="${setup}/setup.iss" />
        <exec basedir="${setup}" executable="iscc">
            <arg value="Setup.iss" />
            <arg value="/Q" />
        </exec>
        <move tofile="MitsuDrv_${version2}_${build}_x64.exe">
            <include name="${setup}/setup.exe" />
        </move>
    </target>

    <target name="makesetup32">
        <property name="Architecture" value="" />
        <property name="Arch" value="Win32" />
        <property name="Archbit" value="32bit" />
        <property name="Arch2" value="(32-bit)" />
        <echo input="${setup}/res/setup_template.iss" file="${setup}/setup.iss" />
        <exec basedir="${setup}" executable="iscc">
            <arg value="Setup.iss" />
            <arg value="/Q" />
        </exec>
        <move tofile="MitsuDrv_${version2}_${build}_x32.exe">
            <include name="${setup}/setup.exe" />
        </move>
    </target>
	
	<target name="makesetup32_nav">
        <property name="Architecture" value="" />
        <property name="Arch" value="Win32" />
        <property name="Archbit" value="32bit" />
        <property name="Arch2" value="(32-bit)" />
        <echo input="${setup}/res/setup_template.iss" file="${setup}/setup.iss" />
        <exec basedir="${setup}" executable="iscc">
            <arg value="Setup.iss" />
            <arg value="/Q" />
        </exec>
        <move tofile="MitsuDrv_${version2}_${build}_x32_nav.exe">
            <include name="${setup}/setup.exe" />
        </move>
    </target>
	
    <target name="makesetup-nosign">
        <echo input="${setup}/res/setup_template.iss" file="${setup}/setup.iss" />
        <exec basedir="${setup}" executable="iscc">
            <arg value="Setup.iss" />
            <arg value="/Q" />
        </exec>
        <move tofile="MitsuDrv_${version2}_${build}.exe">
            <include name="${setup}/setup.exe" />
        </move>
        <delete file="${setup}/setup.iss" />
    </target>
    <target name="sign">
        <exec executable="SignShtrih.bat">
            <arg value="${bin}/Win32/MitsuDrv.dll" />
        </exec>
        <exec executable="SignShtrih.bat">
            <arg value="${bin}/Win64/MitsuDrv.dll" />
        </exec>
        <exec executable="SignShtrih.bat">
            <arg value="${bin}/Win32/MitsuDrvTest.exe" />
        </exec>
        <exec executable="SignShtrih.bat">
            <arg value="${bin}/Win64/MitsuDrvTest.exe" />
        </exec>
        <exec executable="SignShtrih.bat">
            <arg value="${bin}/Win32/1c/32/MitsuDrv1CNative.dll" />
        </exec>
        <exec executable="SignShtrih.bat">
            <arg value="${bin}/Win32/1c/40/MitsuDrv1CNative.dll" />
        </exec>
        <exec executable="SignShtrih.bat">
            <arg value="${bin}/Win64/1c/32/MitsuDrv1CNative.dll" />
        </exec>
        <exec executable="SignShtrih.bat">
            <arg value="${bin}/Win64/1c/40/MitsuDrv1CNative.dll" />
        </exec>
    </target>

    <target name="signinstaller">
        <exec executable="SignShtrih.bat">
            <arg value="${bin}\..\MitsuDrv_${version2}_${build}_x32.exe" />
        </exec>
        <exec executable="SignShtrih.bat">
            <arg value="${bin}\..\MitsuDrv_${version2}_${build}_x64.exe" />
        </exec>
    </target>
	
	<target name="signinstaller_nav">
        <exec executable="SignShtrih.bat">
            <arg value="${bin}\..\MitsuDrv_${version2}_${build}_x32_nav.exe" />
        </exec>
    </target>

    <target name="zipinstaller">
        <exec executable="7z.exe">
            <arg value="a" />
            <arg value="-tzip" />
            <arg value="${bin}\..\MitsuDrv_${version2}_${build}_x32_x64.zip" />
            <arg value="${bin}\..\MitsuDrv_${version2}_${build}_x32.exe" />
            <arg value="${bin}\..\MitsuDrv_${version2}_${build}_x64.exe" />
        </exec>
        <echo message="dir = ${bin}\..\Builds\MitsuDrv_${version2}_${build}" />
        <mkdir dir="${bin}\..\Builds\MitsuDrv_${version2}_${build}" />
        <move todir="${bin}\..\Builds\MitsuDrv_${version2}_${build}">
            <include name="${bin}\..\MitsuDrv_${version2}_${build}_x32_x64.zip" />
        </move>
        <move todir="${bin}\..\Builds\MitsuDrv_${version2}_${build}">
            <include name="${bin}\..\MitsuDrv_${version2}_${build}_x32.exe" />
        </move>
        <move todir="${bin}\..\Builds\MitsuDrv_${version2}_${build}">
            <include name="${bin}\..\MitsuDrv_${version2}_${build}_x64.exe" />
        </move>
    </target>
	
	<target name="zipinstaller_nav">
        <exec executable="7z.exe">
            <arg value="a" />
            <arg value="-tzip" />
            <arg value="${bin}\..\MitsuDrv_${version2}_${build}_x32_nav.zip" />
            <arg value="${bin}\..\MitsuDrv_${version2}_${build}_x32_nav.exe" />
            
        </exec>
        <echo message="dir = ${bin}\..\Builds\MitsuDrv_${version2}_${build}" />
        <mkdir dir="${bin}\..\Builds\MitsuDrv_${version2}_${build}" />
        <move todir="${bin}\..\Builds\MitsuDrv_${version2}_${build}">
            <include name="${bin}\..\MitsuDrv_${version2}_${build}_x32_nav.zip" />
        </move>
        <move todir="${bin}\..\Builds\MitsuDrv_${version2}_${build}">
            <include name="${bin}\..\MitsuDrv_${version2}_${build}_x32.exe" />
        </move>
    </target>
	
    <target name="Make1CComponent">
        <delete dir="${res}/1C/32">
            <include name="*.xml" />
            <include name="*.zip" />
        </delete>
        <move tofile="${bin}/Win32/1c/32/${component_1c_32_win32_dll}">
            <include name="${bin}/Win32/1c/32/MitsuDrv1CNative.dll" />
        </move>
        <move tofile="${bin}/Win64/1c/32/${component_1c_32_win64_dll}">
            <include name="${bin}/Win64/1c/32/MitsuDrv1CNative.dll" />
        </move>
        <exec executable="${res}/1C/32/manifest1cgen.exe">
            <arg value="${component_1c_32_win32_dll} ${component_1c_32_win64_dll} 3" />
        </exec>
        <exec executable="7z.exe">
            <arg value="a" />
            <arg value="-tzip" />
            <arg value="${res}/1C/32/shtrih-m_32_x32_64.zip" />
            <arg value="${bin}/Win32/1c/32/${component_1c_32_win32_dll}" />
            <arg value="${bin}/Win64/1c/32/${component_1c_32_win64_dll}" />
            <arg value="${res}/1C/32/INFO.xml" />
            <arg value="${res}/1C/32/MANIFEST.xml" />
        </exec>
    </target>
    <target name="Make1CComponent34">
        <delete dir="${res}/1C/40">
            <include name="*.xml" />
            <include name="*.zip" />
        </delete>
        <move tofile="${bin}/Win32/1c/40/${component_1c_40_win32_dll}">
            <include name="${bin}/Win32/1c/40/MitsuDrv1CNative.dll" />
        </move>
        <move tofile="${bin}/Win64/1c/40/${component_1c_40_win64_dll}">
            <include name="${bin}/Win64/1c/40/MitsuDrv1CNative.dll" />
        </move>
        <exec executable="${res}/1C/40/manifest1cgen.exe">
            <arg value="${component_1c_40_win32_dll} ${component_1c_40_win64_dll} 4 ${version}" />
        </exec>
        <exec executable="7z.exe">
            <arg value="a" />
            <arg value="-tzip" />
            <arg value="${res}/1C/40/shtrih-m_40_x32_64.zip" />
            <arg value="${bin}/Win32/1c/40/${component_1c_40_win32_dll}" />
            <arg value="${bin}/Win64/1c/40/${component_1c_40_win64_dll}" />
            <arg value="${res}/1C/40/INFO.xml" />
            <arg value="${res}/1C/40/MANIFEST.xml" />
        </exec>
    </target>
    <target name="res">
        <echo input="${MitsuDrv}/MitsuDrv.rt" file="${MitsuDrv}/MitsuDrv_ver.rc" />
        <exec executable="${brcc}">
            <arg value="${MitsuDrv}/MitsuDrv_ver.rc ${MitsuDrv}/MitsuDrv_ver.res" />
        </exec>
    </target>
    <target name="build_MitsuDrv1C">
        <echo input="${MitsuDrv}/MitsuDrv_ver.rt" file="${MitsuDrv}/MitsuDrv_ver.rc" />
        <exec executable="${brcc}">
            <arg value="${MitsuDrv}/MitsuDrv_ver.rc" />
        </exec>
        <exec executable="msbuild.exe">
            <arg value="/clp:ErrorsOnly /t:Build  ${MitsuDrv}/MitsuDrv.dproj /p:Platform=Win32 /p:Config=Release /p:DCC_ExeOutput=../../Setup/MitsuDrv/Bin/Win32" />
        </exec>
        <exec executable="msbuild.exe">
            <arg value="/clp:ErrorsOnly /t:Build  ${MitsuDrv}/MitsuDrv.dproj /p:Platform=Win64 /p:Config=Release /p:DCC_ExeOutput=../../Setup/MitsuDrv/Bin/Win64" />
        </exec>
    </target>
	<target name="build_MitsuDrv_nav">
        <echo input="${MitsuDrv}/MitsuDrv_ver.rt" file="${MitsuDrv}/MitsuDrv_ver.rc" />
        <exec executable="${brcc}">
            <arg value="${MitsuDrv}/MitsuDrv_ver.rc" />
        </exec>
        <exec executable="msbuild.exe">
            <arg value="/clp:ErrorsOnly /t:Build  ${MitsuDrv}/MitsuDrv.dproj /p:Platform=Win32 /p:Config=Release /p:DCC_Define=VER_NAV /p:DCC_ExeOutput=../../Setup/MitsuDrv/Bin/Win32" />
        </exec>
        <exec executable="msbuild.exe">
            <arg value="/clp:ErrorsOnly /t:Build  ${MitsuDrv}/MitsuDrv.dproj /p:Platform=Win64 /p:Config=Release /p:DCC_Define=VER_NAV /p:DCC_ExeOutput=../../Setup/MitsuDrv/Bin/Win64" />
        </exec>
    </target>
	
    <target name="build_MitsuDrvTest">
        <echo input="${MitsuDrvTest}/MitsuDrvTest_ver.rt" file="${MitsuDrvTest}/MitsuDrvTest_ver.rc" />
        <exec executable="${brcc}">
            <arg value="${MitsuDrvTest}/MitsuDrvTest_ver.rc" />
        </exec>
        <exec executable="msbuild.exe">
            <arg value="/clp:ErrorsOnly /t:Build  ${MitsuDrvTest}/MitsuDrvTest.dproj /p:Platform=Win32 /p:Config=Release /p:DCC_ExeOutput=../../Setup/MitsuDrv/Bin/Win32" />
        </exec>
        <exec executable="msbuild.exe">
            <arg value="/clp:ErrorsOnly /t:Build  ${MitsuDrvTest}/MitsuDrvTest.dproj /p:Platform=Win64 /p:Config=Release /p:DCC_ExeOutput=../../Setup/MitsuDrv/Bin/Win64" />
        </exec>
    </target>
    <target name="build_1cnative">
        <echo input="${MitsuDrv1CNative}/MitsuDrv1CNative_ver.rt" file="${MitsuDrv1CNative}/MitsuDrv1CNative_ver.rc" />
        <exec executable="${brcc}">
            <arg value="${MitsuDrv1CNative}/MitsuDrv1CNative_ver.rc" />
        </exec>
        <exec executable="msbuild.exe">
            <arg value="/clp:ErrorsOnly /t:Build  ${MitsuDrv1CNative}/MitsuDrv1CNative.dproj /p:Platform=Win32 /p:Config=Release /p:DCC_Define=V1C_34 /p:DCC_ExeOutput=../../Setup/MitsuDrv/Bin/Win32/1C/40 /p:DCC_DcuOutput=../../Setup/MitsuDrv/Dcu/Win32/1c/40" />
        </exec>
        <exec executable="msbuild.exe">
            <arg value="/clp:ErrorsOnly /t:Build  ${MitsuDrv1CNative}/MitsuDrv1CNative.dproj /p:Platform=Win64 /p:Config=Release /p:DCC_Define=V1C_34 /p:DCC_ExeOutput=../../Setup/MitsuDrv/Bin/Win64/1C/40 /p:DCC_DcuOutput=../../Setup/MitsuDrv/Dcu/Win64/1c/40" />
        </exec>
        <exec executable="msbuild.exe">
            <arg value="/clp:ErrorsOnly /t:Build  ${MitsuDrv1CNative}/MitsuDrv1CNative.dproj /p:Platform=Win32 /p:Config=Release /p:DCC_Define=V1C_32 /p:DCC_ExeOutput=../../Setup/MitsuDrv/Bin/Win32/1C/32 /p:DCC_DcuOutput=../../Setup/MitsuDrv/Dcu/Win32/1c/32" />
        </exec>
        <exec executable="msbuild.exe">
            <arg value="/clp:ErrorsOnly /t:Build  ${MitsuDrv1CNative}/MitsuDrv1CNative.dproj /p:Platform=Win64 /p:Config=Release /p:DCC_Define=V1C_32 /p:DCC_ExeOutput=../../Setup/MitsuDrv/Bin/Win64/1C/32 /p:DCC_DcuOutput=../../Setup/MitsuDrv/Dcu/Win64/1c/32" />
        </exec>
    </target>
	
    <target name="compile" depends="clean, build_MitsuDrv, build_MitsuDrvTest, build_1cnative" />
	<target name="compile_nav" depends="clean, build_MitsuDrv_nav, build_MitsuDrvTest, build_1cnative" />
    <target name="build" depends="compile, sign, Make1CComponent, Make1CComponent34, makesetup32, makesetup64, signinstaller, zipinstaller" />
    <target name="buildxp" depends="compile, sign, Make1CComponent, Make1CComponent34, makesetup32xp, signinstallerxp, zipinstallerxp" />
    <target name="buildnav" depends="compile_nav, sign, Make1CComponent, Make1CComponent34, makesetup32_nav, signinstaller_nav, zipinstaller_nav" />

    <target name="build2" depends="compile, Make1CComponent, makesetup32, makesetup64, zipinstaller" />
    <target name="build-nosign" depends="compile, Make1CComponent, makesetup32, makesetup64, zipinstaller" />
</project>